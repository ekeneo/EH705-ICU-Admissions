---
title: "ICU Admissions Term Project, eH705"
author: "Group XYZ"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document: 
    number_sections: TRUE
    code_folding: hide
    toc: yes
    toc_float: 
      toc_collapsed: true
    includes:
      after_body: footer.html
    theme: journal
    fig_height: 4
    fig_width: 4
    fig_align: center
    font_family: Times New Roman, Times, serif
    font_size: 2.5em
    linestretch: 1.5
---

```{r setup, eval=TRUE, include=FALSE}  
knitr::opts_chunk$set( comment=NA, eval=TRUE,  echo=TRUE, warning=FALSE, message=FALSE, error=FALSE, root.dir = "C:/Users/ekene/Documents/eH705_Project") 
pacman::p_load(psych, ggplot2, DT, sjPlot, knitr, DescTools,
               ggcorrplot, qgraph, corrr, tidyverse, Hmisc )
```

```{r echo=FALSE}
# include this code chunk as-is to set options
knitr::opts_chunk$set(comment=NA, prompt=TRUE, out.width=750, fig.height=8, fig.width=8)
library(Rcmdr)
library(car)
library(RcmdrMisc)
```


```{r echo=FALSE}
# include this code chunk as-is to enable 3D graphs
library(rgl)
knitr::knit_hooks$set(webgl = hook_webgl)
```

# About the ICU Admissions Dataset

Description: The data consist of 200 subjects from a larger study on the survival of patients following admission to an adult intensive care unit (ICU). The study used logistic regression to predict the probability of survival for these patients until their discharge from the hospital. The dependent variable is the binary variable Vital Status (STA). Nineteen possible predictor variables, both discrete and continuous, were also observed. 
Number of cases: 200 
Variable Names: 

  1.	ID: ID number of the patient 
  2.	STA: Vital status (0 = Lived, 1 = Died) 
  3.	AGE: Patient's age in years 
  4.	SEX: Patient's sex (0 = Male, 1 = Female) 
  5.	RACE: Patient's race (1 = White, 2 = Black, 3 = Other) 
  6.	SER: Service at ICU admission (0 = Medical, 1 = Surgical) 
  7.	CAN: Is cancer part of the present problem? (0 = No, 1 = Yes) 
  8.	CRN: History of chronic renal failure (0 = No, 1 = Yes) 
  9.	INF: Infection probable at ICU admission (0 = No, 1 = Yes) 
  10.	CPR: CPR prior to ICU admission (0 = No, 1 = Yes) 
  11.	SYS: Systolic blood pressure at ICU admission (in mm Hg) 
  12.	HRA: Heart rate at ICU admission (beats/min) 
  13.	PRE: Previous admission to an ICU within 6 months (0 = No, 1 = Yes) 
  14.	TYP: Type of admission (0 = Elective, 1 = Emergency) 
  15.	FRA: Long bone, multiple, neck, single area, or hip fracture (0 = No, 1 = Yes) 
  16.	PO2: PO2 from initial blood gases (0 = >60, 1 = ²60) 
  17.	PH: PH from initial blood gases (0 = ³7.25, 1 <7.25) 
  18.	PCO: PCO2 from initial blood gases (0 = ²45, 1 = >45) 
  19.	BIC: Bicarbonate from initial blood gases (0 = ³18, 1 = <18) 
  20.	CRE: Creatinine from initial blood gases (0 = ²2.0, 1 = >2.0) 
  21.	LOC: Level of consciousness at admission (0 = no coma or stupor, 1= deep stupor, 2 = coma) 

# Reading in the ICU Admissions Dataset
```{r}
# ICU <- read.table("C:/Users/ekene/OneDrive - McMaster University/Avenue2Learn_Winter2020/EH 705/eh705termproject/ICUAdmissions.csv", header=TRUE, sep=",", na.strings="NA", dec=".", strip.white=TRUE)
ICU <- read.table("./ICUAdmissions.csv", header=TRUE, sep=",", na.strings="NA", dec=".", strip.white=TRUE)
```

```{r}
str(ICU)
```

## Findings

The ICU Admissions dataset consists of 200 observations with 21 variables. From the following observations we found;

  1. The dependent variable is the binary variable Vital Status (Status).   
  2. Nineteen possible predictor variables, both discrete and continuous, were also observed. 
  3. Most of the variables are integer but from information about the data, most of the variables can be recoded to factor variables.  
  4. There are only four variables that can be left as numerical variables others can be recoded to categorical/factor variables.  
  5. There would be a need to recode the categorical variables to factors.  
  6. There are no missing data  
  

# Converting Numerical variables to Factor Variables

Labelling the factor levels helps with comparative analysis and visualization

```{r}
ICU <- within(ICU, {
  Status <- factor(Status, labels=c('Lived','Died'))
  Sex <- factor(Sex, labels=c('Male','Female'))
  Race <- factor(Race, labels=c('White','Black','Other'))
  Service <- factor(Service, labels=c('Medical','Surgical'))
  Cancer <- factor(Cancer, labels=c('No','Yes'))
  Renal <- factor(Renal, labels=c('No','Yes'))
  Infection <- factor(Infection, labels=c('No','Yes'))
  CPR <- factor(CPR, labels=c('No','Yes'))
  Previous <- factor(Previous, labels=c('No','Yes'))
  Type <- factor(Type, labels=c('Elective','Emergency'))
  Fracture <- factor(Fracture, labels=c('No','Yes'))
  PCO2 <- factor(PCO2, labels=c('No','Yes'))
  PH <- factor(PH, labels=c('No','Yes'))
  PO2 <- factor(PO2, labels=c('No','Yes'))
  Bicarbonate <- factor(Bicarbonate, labels=c('No','Yes'))
  Creatinine <- factor(Creatinine, labels=c('No','Yes'))
  Consciousness <- factor(Consciousness, labels=c('Conscious','Deep Stupor','Coma'))
})
```

## Viewing a few rows of the recorded dataset
```{r}
headTail(ICU) %>% datatable(rownames = TRUE, filter="top", options = list(pageLenght = 10, scrollX=T))%>% formatRound(columns=c(1:17), digits=0)
```

## Saving new recoded dataset
```{r}
# write.csv(ICU, file="ICUAdmissions_recoded.csv", row.names=FALSE)
```

# Data Exploration - Statistical summaries and Graphing of variables

```{r}
str(ICU)
```

**Findings**
* The following variables were successfully recoded; Status, Sex, Race, Service, Cancer, Renal, Infection, CPR, Previous, Type,Fracture, PCO2,PH, PO2, Bicarbonate, Creatinine, and Consciousness. 

## Statistical summary of the recoded dataset
```{r}
summary(ICU)
```

## Numerical Summary of Int VAriables
```{r}
numSummary(ICU[,c("Age", "HeartRate", "Systolic"), drop=FALSE], statistics=c("mean", "sd", "IQR", 
  "quantiles"), quantiles=c(0,.25,.5,.75,1))
```

## Findings

* Age ranges from 16-92 years old with a mean of 57.55 and median of 63
* Systolic blood pressure ranges from 36-256 with a mean of 132.3 and median of 130
* Heart rate ranges from 39-192 beats per minute with a mean of 98.92 and median of 96

# Graphing

## Examining the variables distribution

```{r echo=FALSE}
xray:: distributions(ICU)
```

## Distribution of Vital Status by the factor variables
```{r}
library(ggplot2)
f01<-ggplot(ICU, aes(x=Sex, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Sex")

f02<-ggplot(ICU, aes(x=Race, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Race")
f03<-ggplot(ICU, aes(x=Service, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Service")

f04<-ggplot(ICU, aes(x=Cancer, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Cancer")

library(Rmisc)
multiplot(f01, f02, f03, f04,  layout=matrix(c(1:4), nrow=2, byrow=TRUE))
```

```{r}

f05<-ggplot(ICU, aes(x=Renal, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Renal")

f06<-ggplot(ICU, aes(x=Infection, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Infection")

f07<-ggplot(ICU, aes(x=CPR, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by CPR")

f08<-ggplot(ICU, aes(x=Previous, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Previous")

library(Rmisc)
multiplot(f05, f06, f07, f08,  layout=matrix(c(1:4), nrow=2, byrow=TRUE))
``` 

```{r}

f09<-ggplot(ICU, aes(x=Type, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Type")

f10<-ggplot(ICU, aes(x=Fracture, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Fracture")

f11<-ggplot(ICU, aes(x=PO2, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by PO2")

f12<-ggplot(ICU, aes(x=PH, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by PH")

library(Rmisc)
multiplot(f09, f10, f11, f12,  layout=matrix(c(1:4), nrow=2, byrow=TRUE))
```

```{r}
f13<-ggplot(ICU, aes(x=PCO2, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by PCO2")

f14<-ggplot(ICU, aes(x=Bicarbonate, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Bicarbonate")

f15<-ggplot(ICU, aes(x=Creatinine, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Creatinine")

f16<-ggplot(ICU, aes(x=Consciousness, fill = Status)) +
 theme_bw() +
 geom_bar() +
 labs(y = "Patient Count",
      title = "Vital Status by Consciousness")


library(Rmisc)
multiplot(f13, f14, f15, f16, layout=matrix(c(1:4), nrow=2, byrow=TRUE))
```



## Plotting the density Distribution of the Numeric Variable

```{r}
d01 <- ggplot(ICU, aes(x=Age)) +
 geom_density(fill="green") +
 ggtitle("Age") +
 theme(axis.title.x=element_text(size=16, face="bold", colour="blue")) +
 theme(axis.text.x=element_text(size=14 )) +
 annotate("text", x=0.8, y=-0.001, label="Base=315",  size=4)

d02 <- ggplot(ICU, aes(x=Systolic)) +
 geom_density(fill="green") +
 ggtitle("Systolic") +
 theme(axis.title.x=element_text(size=16, face="bold", colour="blue")) +
 theme(axis.text.x=element_text(size=14 )) +
 annotate("text", x=0.8, y=-0.001, label="Base=315",  size=4)

d03 <- ggplot(ICU, aes(x=HeartRate)) +
 geom_density(fill="green") +
 ggtitle("HeartRate") +
 theme(axis.title.x=element_text(size=16, face="bold", colour="blue")) +
 theme(axis.text.x=element_text(size=14 )) +
 annotate("text", x=0.8, y=-0.001, label="Base=315",  size=4)

d04 <- ggplot(ICU, aes(x=ID)) +
 geom_density(fill="green") +
 ggtitle("ID") +
 theme(axis.title.x=element_text(size=16, face="bold", colour="blue")) +
 theme(axis.text.x=element_text(size=14 )) +
 annotate("text", x=0.8, y=-0.001, label="Base=315",  size=4)

multiplot(d01, d02, d03, d04, layout=matrix(c(1:4), nrow=2, byrow=TRUE))

```


## Density plot of Vital Status by Numeric variables 
```{r}
n01<-ggplot(ICU, aes(x=Age, fill = Status)) +
  theme_bw() +
      geom_density(alpha=0.5) +
  labs(y = "Density",
       title = "Density distribution of Vital Status by Age")

n02<-ggplot(ICU, aes(x=Systolic, fill = Status)) +
  theme_bw() +
      geom_density(alpha=0.5) +
  labs(y = "Density",
       title = "Density distribution of Vital Status Systolic")

n03<-ggplot(ICU, aes(x=HeartRate, fill = Status)) +
  theme_bw() +
      geom_density(alpha=0.5) +
  labs(y = "Density",
       title = "Density distribution of Vital Status HeartRate")

n04<-ggplot(ICU, aes(x=Age, fill = Status)) +
  theme_bw() +
  facet_wrap(~ Sex) +
      geom_density(alpha=0.5) +
  labs(y = "Density",
       title = "Density distribution of Vital Status in male and female patients by Age")

multiplot(n01, n02, n03, n04, layout=matrix(c(1:4), nrow=2, byrow=TRUE))
```

## Observations

  - There are more male than female in the population.
  - The number of patient who live is higher than the population who died
  - More Patients from the population aged 50 and above died in both male and female
  - The female population experienced more death than men of the same age bracket as 
  - The desity plot is peaked at the top at the age 75 for both male and female meaning more patients aged 75 died.

# Distribution
```{r}
with(ICU, qqPlot(Systolic, dist="norm", id=list(method="y", n=2, 
  labels=rownames(ICU)), main="Systolic"))
```

```{r}
normalityTest(~Systolic, test="shapiro.test", data=ICU)
```

```{r}
with(ICU, qqPlot(HeartRate, dist="norm", id=list(method="y", n=2, 
  labels=rownames(ICU)), main="Heartrate"))
```

```{r}
normalityTest(~HeartRate, test="shapiro.test", data=ICU)
```

```{r}
with(ICU, qqPlot(Age, dist="norm", id=list(method="y", n=2, 
  labels=rownames(ICU)), main="Age"))
```

```{r}
normalityTest(~Age, test="shapiro.test", data=ICU)
```

# Differences in Means

## Summary Statistics 

```{r}
numSummary(ICU[,c("Age", "Systolic", "HeartRate"), drop=FALSE], groups=ICU$Status, statistics=c("mean", "sd", "se(mean)"),quantiles=c(0,.25, .5, .75,1))
```

```{r}
library(psych)
describeBy(ICU, ICU$Status)
```

## Age by Status
__Ho:__ the variances for Lived and Died are equal  
__Ha:__ the variances are different

__Ho:__ the means are equal  
__Ha:__ the means are different

The following is the comparison of variances between the two Status groups for Age.

```{r}
with(ICU, tapply(Age, Status, var, na.rm=TRUE))
```

The following code produces the result of the LeveneTest for testing homogeneity of variances.

```{r}
leveneTest(Age ~ Status, data=ICU, center="median")
```

Since the p value = 0.07855 for testing the homogeneity of variances is greater than 0.05, we retain the null hypothesis with a 5% risk of a type 1 error and conclude that the variances for Lived and Died are equal. As such, the Student t-test is used to analyze whether there was a significant difference in means.


```{r}
t.test(Age~Status, alternative='two.sided', conf.level=.95, var.equal=TRUE, data=ICU)
qt(c(0.025), df=314, lower.tail=TRUE)
```

As the p-value = 0.007211, 0 is not within the confidence intervals of -16.35688 to -2.59312 and t = -2.7151 is less than -1.967548, we reject the null hypothesis and conclude that the means for Age for the groups Lived and Died are not the same. 


## HeartRate by Status
__Ho:__ the variances for Lived and Died are equal  
__Ha:__ the variances are different

__Ho:__ the means are equal  
__Ha:__ the means are different

The following is the comparison of variances between the two Status groups for HeartRate.
```{r}
with(ICU, tapply(HeartRate, Status, var, na.rm=TRUE))
```

The following code produces the result of the LeveneTest for testing homogeneity of variances.
```{r}
leveneTest(HeartRate ~ Status, data=ICU, center="median")
```

Since the p-value = 0.929 for testing the homogeneity of variances is greater than 0.05, we retain the null hypothesis with a 5% risk of a type 1 error and conclude that the variances for Lived and Died are equal. As such, the Student t-test is used to analyze whether there was a significant difference in means.

```{r}
t.test(HeartRate~Status, alternative='two.sided', conf.level=.95, var.equal=TRUE, data=ICU)
qt(c(0.025), df=314, lower.tail=TRUE)
```

As the p-value = 0.6553, 0 is within the confidence intervals of -11.496845 to 7.246845 and t = -0.44714 is greater than -1.967548, we retain the null hypothesis at a 5% risk level of a type 1 error and conclude that the means for HeartRate are the same among those that lived and those that died. 

## Systolic by Status
__Ho:__ the variances for Lived and Died are equal  
__Ha:__ the variances are different  

__Ho:__ the means are equal  
__Ha:__ the means are different

The following is the comparison of variances between the two Status groups for Systolic.
```{r}
with(ICU, tapply(Systolic, Status, var, na.rm=TRUE))
```

The following code produces the result of the LeveneTest for testing homogeneity of variances.
```{r}
leveneTest(Systolic ~ Status, data=ICU, center="median")
```

Since the p-value = 0.04205 for testing the homogeneity of variances is less than 0.05, we reject the null hypothesis with a 5% risk of a type 1 error and conclude that the variances for Lived and Died are not equal. As such, the Welch two Sample t-test is used to analyze whether there was a significant difference in means. 

```{r}
t.test(Systolic~Status, alternative="two.sided", conf.level=.95, var.equal=FALSE, data=ICU)
qt(c(0.025), df=314, lower.tail=TRUE)
```

As the p-value = 0.01856, 0 is not within the confidence intervals of  2.938642 to 30.698858 and t = 2.4341 is greater than 1.9675, we reject the null hypothesis at a 5% risk level of a type 1 error and conclude that the means for systolic blood pressure are not the same among those that lived and those that died. 


## Age by Sex
__Ho:__ the variances for Lived and Died are equal  
__Ha:__ the variances are different

__Ho:__ the means are equal  
__Ha:__ the means are different

The following is the comparison of variances between the two Sex groups for Age.

```{r}
with(ICU, tapply(Age, Sex, var, na.rm=TRUE))
```

The following code produces the result of the LeveneTest for testing homogeneity of variances.
```{r}
leveneTest(Age ~ Sex, data=ICU, center="median")
```

Since the p-value = 0.7344 for testing the homogeneity of variances is greater than 0.05, we retain the null hypothesis with a 5% risk of a type 1 error and conclude that the variances for Lived and Died are equal. As such, the Student t-test is used to analyze whether there was a significant difference in means.

```{r}
t.test(Age~Sex, alternative='two.sided', conf.level=.95, var.equal=TRUE, data=ICU)
qt(c(0.025), df=314, lower.tail=TRUE)
```

As the p-value = 0.1759, 0 is within the confidence intervals of -9.708824 to 1.789469 and t = -1.3582 is greater than - 1.9675, we retain the null hypothesis at a 5% risk level of a type 1 error and conclude that the means for systolic blood pressure are the same between the two groups.


